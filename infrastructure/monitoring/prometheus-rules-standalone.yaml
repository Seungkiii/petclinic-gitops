apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: petclinic-scaling-alerts
  namespace: monitoring
  labels:
    release: my-monitoring
spec:
  groups:
    - name: hpa-scaling
      interval: 30s
      rules:
        - alert: HPAScalingActivity
          expr: |
            abs(
              kube_horizontalpodautoscaler_status_current_replicas
              - 
              kube_horizontalpodautoscaler_status_desired_replicas
            ) > 0
          for: 1m
          labels:
            severity: info
            component: hpa
          annotations:
            summary: 'âš¡ HPA is scaling {{ $labels.horizontalpodautoscaler }}'
            description: 'Current: {{ $value }} replicas. Adjusting to meet demand.'
        
        - alert: HPAMaxReplicasReached
          expr: |
            kube_horizontalpodautoscaler_status_current_replicas 
            >= 
            kube_horizontalpodautoscaler_sc_max_replicas
          for: 2m
          labels:
            severity: warning
            component: hpa
          annotations:
            summary: 'âš ï¸ HPA reached max replicas'
            description: 'HPA {{ $labels.horizontalpodautoscaler }} reached maximum: {{ $value }} replicas. Consider increasing limits.'
        
        - alert: HighCPUUtilization
          expr: |
            avg(rate(container_cpu_usage_seconds_total{namespace="default",container!=""}[5m])) by (pod) 
            / 
            avg(kube_pod_container_resource_requests{resource="cpu", namespace="default"}) by (pod) 
            > 0.8
          for: 2m
          labels:
            severity: warning
            component: pod
          annotations:
            summary: 'ðŸ”¥ {{ $labels.pod }} has high CPU'
            description: 'CPU usage: {{ $value | humanizePercentage }} of request'
    
    - name: karpenter-scaling
      interval: 30s
      rules:
        - alert: KarpenterNodeCreated
          expr: |
            in(karpenter_nodeclaims_created_total[2m]) > 0
          labels:
            severity: info
            component: karpenter
          annotations:
            summary: 'ðŸš€ Karpenter created new node(s)'
            description: 'NodePool created {{ $value }} new node(s)'
        
        - alert: KarpenterNodeTerminated
          expr: |
            increase(karpenter_nodeclaims_terminated_total[2m]) > 0
          labels:
            severity: info
            component: karpenter
          annotations:
            summary: 'âœ… Karpenter terminated node(s)'
            description: 'NodePool terminated {{ $value }} node(s) to save cost'
        
        - alert: KarpenterHighPendingPods
          expr: |
            sum(kube_pod_status_phase{phase="Pending", namespace="default"}) > 5
          for: 3m
          labels:
            severity: warning
            component: karpenter
          annotations:
            summary: 'â³ {{ $value }} pods pending scheduling'
            description: 'Multiple podsng for >3 minutes. Karpenter may need to provision nodes.'
